<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment Successful</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="message">
      <h1>✅ Payment Successful!</h1>
      <p>Thank you for your payment.</p>

      <p>
        <strong>Name:</strong>
        <span id="customer-name">Loading...</span>
      </p>

      <p>Your payment was completed on:</p>
      <p id="payment-date" class="date-box">Loading...</p>

      <a href="index.html">Return to Shop</a>
    </div>

    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get("session_id");

        const nameEl = document.getElementById("customer-name");
        const dateEl = document.getElementById("payment-date");

        if (!sessionId) {
          console.error("No session_id in URL");
          nameEl.textContent = "Error";
          dateEl.textContent = "Could not load details";
          return;
        }

        try {
          const res = await fetch(
            "https://shop-backend-dom2.onrender.com/checkout-session?session_id=" +
              encodeURIComponent(sessionId)
          );

          if (!res.ok) {
            throw new Error("Bad response: " + res.status);
          }

          const data = await res.json();
          console.log("Checkout session:", data);

          nameEl.textContent = data.customer_name || "Unknown";
          dateEl.textContent = data.date || "Unknown date";

          // optional: notify you by email – can fail silently
          fetch("https://shop-backend-dom2.onrender.com/notify-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              customer_name: data.customer_name,
              date: data.date,
              amount_total: data.amount_total,
            }),
          }).catch((err) => console.warn("notify-payment failed:", err));
        } catch (err) {
          console.error("Failed to load session details:", err);
          nameEl.textContent = "Error";
          dateEl.textContent = "Could not load details";
        }
      })();
    </script>
  </body>
</html>
