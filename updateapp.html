<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App Activation Payment</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
     <script>
    (function () {
      const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
      if (!isLoggedIn) {
        localStorage.setItem("postLoginRedirect", "index.html"); // change to this page's file name
        window.location.href = "login.html";
      }
    })();
  </script>

 <header>
      <h1><a href="./index.html" class="home-link">Sonda SHOP</a></h1>
      <div>Cart: <span id="cart-count">0</span></div>
      <div style="margin-top: 30px">
        <button class="button-check" id="cart-button">Fizet√©s!</button>
      </div>
    </header>

    <main>
      <div>
        <p>Ha lej√°rt az appod, itt tudod k√ºldeni az √°rat. <br>
          <strong>Ez nem a havi el≈ëfizet√©s!</strong></p>
      </div>

      <!-- ‚úÖ Payer name -->
      <div class="checkout-box" style="margin-top: 20px">
        <label for="payer-name">Neved k√©rem:</label>
        <input
          type="text"
          id="payer-name"
          placeholder="√çrd be a neved"
          required
        />
      </div>

      <!-- ‚úÖ App payment product -->
      <div class="checkout-box" style="margin-top: 20px">
        <div class="product" data-name="App √©ves aktiv√°l√°s" data-price="3.20">
          <img id="png" src="./tv-icon-13.png" alt="App" />
          <div class="price">Tv App √âves Aktiv√°l√°s ¬£3.20</div>
          <button id="add-to-cart">Hozz√°ad√°s a kos√°rhoz</button>
        </div>
      </div>
    </main>

    <!-- ‚úÖ Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

       <!-- ‚úÖ Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <script>
      const stripe = Stripe(
        "pk_live_51N67KeFYbT9vhXCbG4eD7Zru8jC4gE6TJCRblelKS4h6TwEC75dKDUhq7cy9o2xee0OVC2EG2OOi7S6MLuGLqM5Q00rtiPwVw5"
      );
      let cart = [];

      // üßÆ Update cart counter in header
      function updateCartCount() {
        const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
        const el = document.getElementById("cart-count");
        if (el) el.textContent = totalQty;
      }

      // ‚ûï Add the app product when clicked
      document.getElementById("add-to-cart").addEventListener("click", () => {
        const payerName = document
          .getElementById("payer-name")
          .value.trim();

        if (!payerName) {
          alert("K√©rlek, add meg a neved!");
          return;
        }

        const price = 3.2;

        if (cart.length === 0) {
          // first time: create item
          cart.push({
            name: payerName,
            price,
            quantity: 1,
          });
        } else {
          // only one product; just increase quantity
          cart[0].quantity += 1;
          cart[0].name = payerName; // optional: keep latest name
        }

        updateCartCount();

        alert(
          `App aktiv√°l√°s (¬£${price.toFixed(
            2
          )}) hozz√°adva ${payerName} n√©vvel!`
        );
      });

      // üßæ Checkout button
      document.getElementById("cart-button").addEventListener("click", () => {
        if (cart.length === 0) {
          alert("A kos√°r √ºres!");
          return;
        }

        console.log("üõí Sending cart:", cart);

        fetch("https://shop-backend-dom2.onrender.com/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            cart, // [{ name, price, quantity }]
            customerName: cart[0].name, // send the user's name
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("üí¨ Server returned:", data);
            if (!data.id) throw new Error("Missing session ID from server!");
            return stripe.redirectToCheckout({ sessionId: data.id });
          })
          .catch((err) => alert("Error: " + err.message));
      });

      // set initial count (0)
      updateCartCount();
    </script>

  </body>
</html>
